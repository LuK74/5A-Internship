# Diary

## Week 10-11-12-13
### Overview
During those 4 weeks (which included Kernel Recipes conferences and some vacations days) I have been doing a lot of manipulation on KVM in order to learn how it works.

### Done
- Finished to learn and master KVM and tools basic and advanced usage (qemu, libvirt, libguestfs, trace-cmd, etc...)
- Finished to setup scripts, tools and configurations files for launching workings VMs on neowise machines (severals bugs and issues encountered which needed to be studied)
- Creation and edition of new images (VM and G5K images, to compare baremetal and VM)
- Ran some benchmarks to compare VM and benchmark (one interesting case that needs to be studied, and some differences with Intel machines)
- Presentation done on one of Eurosys 22 papers (Slashing the disaggregation tax in heterogeneous data centers with FractOS)
- Spend some time trying to fix an issue on sirius machine (which seems to have been a G5K issue since it has been fixed after two days of admin maintenance on sirius machines)
- Attended kernel recipes conferences
- Started to wrote a document about my experiences with KVM virtualization (bugs encountered, solutions, etc...)
- Started to wrote a document about how to know a few specifics of the hardware we're using

### TODO
- Continue to run benchmarks and neowise baremetal and VM
- Start to run benchmarks and sirius machines
- Run same experiments on Intel machines to observe differences in behaviour
- Finish the document about how to know a few specifics of the hardware we're using
- Get back into phoronix benchmarks
- Do a clean of AMD observations

## Week 7-8-9
### Overview
During those 3 weeks I've been finishing the study of the newest Linux kernels (5.15,5.16,5.17) and I've been starting to look at virtualization.
Also a new machine was released on Grid'5000 (sirius) which has a new hardware layout (2 sockets, clusters of 4 cores, new topology level) so I've been running experiments on it.

### Done
- Conclude on governors that they are indeed working but due to the fact that AMD machines run easily at high frequency, the performance governor isn't very useful
- Linux Kernel 5.16 issue resolved : Configuration issue, an option was turned off which was normally inlining some code in order to make the kernel more efficient
- Finised setting up phoronix benchmark and automating it.
- Runned some phoronix benchmarks
- Gather final results for neowise machines (nas, configure, dacapo), currently doing it for phoronix
- Currently establishing new experiments and choosing experiences useful in order to study the hardware of a machine (will establish a methodology)
- Discovered and explored new machine, sirius. Explored topology, runned configure and nas benchmark on it (interesting results).
- Added syscall to Linux debug kernel in order to print scheduling domain information for neowise and sirius machine
- Started to look at virtualization and setting it up (scripts to automate the deployment, etc...)
- Still studying hyperthreading on AMD machines and comparison done with dahu machines (Intel) in order to determine if hyperthreading should be used by AMD machines

### TODO
- Run phoronix benchmark on neowise (this weekend)
- Run dacapo benchmark on sirius
- Deploy a VM and run some benchmark on it
- Keep studying AMD hardware
- Establish a methodology to determine how the hardware work (which experiments to run, what information should we look for, etc...)
- Update recap document

### Done

## Week 5-6
### Overview
Most of the two weeks were focused on a lot of code reading.
I read a lot of Linux kernel scheduler code in order to understand how work the most important pieces of the scheduler.
It will help to determine where the performances differences between 5.15 and 5.16 come from.  

### Done
- Creation of new image containing debug version of Linux Kernel 5.15 and 5.16 (printing some information about scheduling decisions)
- Read and understood some of the most important Linux scheduler code pieces
- Look at the code differences between 5.15 and 5.16 (scheduler part only) : https://lore.kernel.org/lkml/163572864855.3357115.17938524897008353101.tglx@xen13/
- Ran configure benchmark on new debug version of Linux Kernel on neowise machines AND dahu machines of Grenoble (in order to check that there is also a performance decrease there, which is the case)
- Analyzed trace generated by debug version of Linux Kernel and repeated some experiments in order to identify possible behaviour differences
- Ran dacapo benchmark (almost entirely, it takes much long than in the Nest artifact because I'm trying 3 different Linux kernel versions)
- Upgrade of some ocaml scripts
- Upgrade of artificial benchmarks and experiments done to determine what is the best task placement on neowise machine
- Tried hackbench benchmark in order to try different kind of workload for the best task placement analysis
- Wrote a document to keep Julia updated about my progess (absent from Wednesday to Friday this week), copy of the document can be found in the AdditionalDocuments folder (file : UpdateWeek6.pdf)

### TODO
- Keep looking for information about why AMD machines are running at a high frequency most of the time
- Look for information about schedutil, performance governors. Does their decisions depends on the material they are running on ?
- Keep digging on the Linux Kernel 5.16 issue
- Try phoronix benchmark
- Rerun nas benchmark
- Complete recap document

## Week 4
### Overview
Fixed the issue with the new kernels (5.15,5.16,5.17), also tried several micro artificial benchmark in order to analyze AMD governor setup behaviour.

### Done
- Fixed issue with new kernels (error in configuration file)
- Update reboot kernel script in order to be able to boot with the new AMD P-State driver (Kernel 5.17 only)
- Benchmark dacapo done with Kernel 5.9 (with cpu usage), few observations needs to be investigated
  - AMD run at high frequency most of the time
  - Some benchmark run at a lower frequency with NEST (which doesn't happen on Intel machines) but they still have better performances
  - Seems like schedutil and performance give the same results (AMD specifics or error in benchmarking method ?)
- Artificial benchmark done, cpu governor setup understood
- Started writing of a recap document for each observation linked to AMD machines
- Benchmark configure (only a few) done with all new kernels, few observations needs to be investigated
  - Performance decrease since Kernel 5.16
  - No difference between amd-pstate driver and regular acpi-controller driver
- Modification on ocaml scripts done
- Artificial benchmarks upgraded and given with a few scripts
- Installation and learning of new tools "stepper" and "count_occurency"
- Presentation of Arachne paper done

### TODO
- Run dacapo benchmark with new kernels
- Study observations done last week
- Prepare phoronix benchmark for neowise machines
- Complete recap document

## Week 3
### Overview
Eurosys'22 week.

## Week 2
### Overview
After running and analyzing the first benchmarks ran with the AMD Zen 2 machines we conclude that there were some strange things in those results :
- CPU Power usage measures inaccurate
- CPU Frequency seems to be running very highly most of the time
And so I tried to investigate those issues. In the meantime I also worked on an update of NEST for the Linux Kernel 5.15, 5.16 and 5.17.

### Done
- CPU Power usage measurement fixed (script compiling those measurements needed an update for handling AMD machines results which are different from the Intel ones)
- CPU Frequency still investigated but it seems that the frequency measurement is correct (we can see that the frequency is reduced when we're running a high number of process, like expected, or at least like we can in an Intel machine)
- Update of NEST for the Linux Kernel 5.15, 5.16 and 5.17 done
- Read and analyzed the following paper for a presentation : "Arachne: Core-Aware Thread Management"
- Mastered and update of some tools (trace-cmd, dat2graph, read_csvs)
- Ran some personal benchmarks which didn't give anything special conclusion except for :
  - The frequency reduction when there is a high number of process
  - Special behaviour when setting two different cpu governors on 2 hyperthreads from the same core

### TODO
- Deploy images with the new kernels (currently, there is an issue which need to be investigated)
- Study the "special behaviour" encountered when setting two different cpu governors on 2 hyperthreads from the same core
- Prepare the presentation of the "Arachne: Core-Aware Thread Management" paper
- Rerun NEST initial benchmarks with CPU power measurement fix and modification on cpu frequency graph drawer script (reduce frequency steps)

## Week 1
### Overview
Firstly, I have to work on AMD machines on Grid'5000 (neowise from the Lyon site) and redoing the NEST paper experience on them.
NEST paper mostly is about Intel Machines, some experiences have been run but it is interesting to study more what happens on those machines.
AMD (Zen 2) machines differs from Intel one due to the chiplet architecture, Intel machines have one L3 caches shared between all the cores whereas AMD machines have several L3 caches shared between a small set of cores. This difference might influence the scheduling of tasks. 

### Done
- Master tools (grid5000, scripts, linux kernel configuration and makefile)
- Read NEST paper : OS Scheduling with Nest: Keeping Tasks Close Together on Warm Cores (https://hal.archives-ouvertes.fr/hal-03612592/)
- Read papers and documentation about AMD Zen 2 architecture
- Run a few benchmarks from the NEST experience on the AMD machines and studied the results
- Design a personal benchmark to run specific experiences to study AMD Zen 2 features

### TODO
- Run personal benchmark and study their results
- Study and try to run with a v5.17.1 Linux Kernel (there might be some interesting AMD options)
- Find the issue about CPU power measurement and fix it
- Run dacapo bencharmk and phoronix benchmarks
